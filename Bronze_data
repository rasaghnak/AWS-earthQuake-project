import os
import json
import time
import datetime
import urllib.request
import boto3

s3 = boto3.client('s3')
BUCKET = os.environ['BUCKET']  # e.g., mdn-demo-datalake-<your-unique>-us-east-1
BRONZE_PREFIX = os.environ.get('BRONZE_PREFIX', 'bronze/webdata')
SOURCE_URL = os.environ.get('SOURCE_URL', 'https://jsonplaceholder.typicode.com/posts')

def lambda_handler(event, context):
    # Fetch from API
    with urllib.request.urlopen(SOURCE_URL) as resp:
        data = json.loads(resp.read().decode('utf-8'))

    # Partition path
    ingest_date = datetime.datetime.utcnow().strftime('%Y-%m-%d')
    ts = int(time.time())
    key = f"{BRONZE_PREFIX}/ingest_date={ingest_date}/batch_{ts}.json"

    # Write raw JSON payload
    s3.put_object(
        Bucket=BUCKET,
        Key=key,
        Body=json.dumps(data).encode('utf-8'),
        ContentType='application/json'
    )

    return {
        "bucket": BUCKET,
        "ingest_date": ingest_date,
        "records": len(data),
        "bronze_key": key
    }
